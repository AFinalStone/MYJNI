5、StyleEffectActivity的具体代码:

```java

public class StyleEffectActivity
  extends Activity
  implements AdapterView.OnItemClickListener
{

  private Button alleffectlable;//“全部”按钮
  private boolean canTouch = false;
  private float density = MyData.nDensity;
  private ProgressBar effectBar;
  private GalleryText effectGallery;//实现textView横排显示的效果
  private ViewEditGalleryText fakeEffectView;
  private boolean isProcessing = false;
  private Animation lastFakeAnimation;
  private Animation lastPicAnimation;
  private Button lomoeffectlable;//“LOMO”按钮
  Handler myHandler = new Handler()
  {
    public void handleMessage(Message paramAnonymousMessage)
    {
      switch (paramAnonymousMessage.what)
      {
      }
      for (;;)
      {
        super.handleMessage(paramAnonymousMessage);
        return;
        StyleEffectActivity.this.setGone();
        //如果图片处理结束，调用viewEffect对象的updateShow()方法进行控件刷新
        StyleEffectActivity.this.viewEffect.updateShow();
      }
    }
  };
  private int[] nGalleryLomo;
  private int[] nGalleryStdio;
  private int nSelectBmp = 0;
  int nTextLength;
  private int nType;
  private Animation nextFakeAnimation;
  private Animation nextPicAnimation;
  private boolean noPic = false;
  private Button photoeffectlable;//“影楼”按钮
  private int[] sListTest;
  private int[] strAlleffect = { 2130837657, 2130837658, 2130837659, 2130837660, 2130837661, 2130837662, 2130837663, 2130837664, 2130837665, 2130837666, 2130837667, 2130837668, 2130837669, 2130837670, 2130837671, 2130837672, 2130837673 };
  private int[] strAlleffects = { 2130837675, 2130837676, 2130837677, 2130837678, 2130837679, 2130837680, 2130837681, 2130837682, 2130837683, 2130837684, 2130837685, 2130837686, 2130837687, 2130837688, 2130837689, 2130837690, 2130837691 };
  Thread threadWait = null;
  public int touchType = -1;
  private ViewEditGalleryText viewEffect;//图片处理和展示的效果控件
  private int xDownSize;
  private int xUpSize;
  
  static
  {
    lastBmp = 0;
    beforeType = 0;
    System.loadLibrary("mtimage-jni");
  }

  ...代码省略...

  protected void onCreate(Bundle paramBundle)
  {
    getWindow().setFlags(1024, 1024);
    super.onCreate(paramBundle);
    setContentView(2130903050);
    System.gc();
    this.nType = getIntent().getIntExtra("type", -1);
    if ((MyData.nScreenW == 0) || (MyData.nScreenH == 0) || (MyData.nDensity == 0.0F))
    {
      paramBundle = getWindowManager().getDefaultDisplay();
      DisplayMetrics localDisplayMetrics = new DisplayMetrics();
      paramBundle.getMetrics(localDisplayMetrics);
      MyData.nScreenW = localDisplayMetrics.widthPixels;
      MyData.nScreenH = localDisplayMetrics.heightPixels;
      MyData.nBmpDstW = MyData.nScreenW;
      MyData.nBmpDstH = MyData.nScreenH - 100;
      MyData.nDensity = localDisplayMetrics.density;
      MTDebug.Print("MTXXActivity onCreate MyData.nScreenW=" + MyData.nScreenW + " MyData.nScreenH=" + MyData.nScreenH + " MyData.nDensity=" + MyData.nDensity);
      this.density = MyData.nDensity;
    }
    this.viewEffect = ((ViewEditGalleryText)findViewById(2131230856));
    this.viewEffect.nType = this.nType;
    this.alleffectlable = ((Button)findViewById(2131230859));
    this.lomoeffectlable = ((Button)findViewById(2131230860));
    this.photoeffectlable = ((Button)findViewById(2131230861));
    this.alleffectlable.setOnClickListener(new OnClassListenerAlleffectlable());
    this.lomoeffectlable.setOnClickListener(new OnClassListenerLomoeffectlable());//“LOMO”按钮设置点击事件
    this.photoeffectlable.setOnClickListener(new OnClassListenerPhotoeffectlable());//“影楼”按钮设置点击事件
    this.nGalleryLomo = new int[11];
    this.nGalleryLomo[0] = 0;
    this.nGalleryLomo[1] = 1;
    this.nGalleryLomo[2] = 16;
    this.nGalleryLomo[3] = 3;
    this.nGalleryLomo[4] = 4;
    this.nGalleryLomo[5] = 8;
    this.nGalleryLomo[6] = 11;
    this.nGalleryLomo[7] = 14;
    this.nGalleryLomo[8] = 12;
    this.nGalleryLomo[9] = 13;
    this.nGalleryLomo[10] = 15;
    this.nGalleryStdio = new int[7];
    this.nGalleryStdio[0] = 0;
    this.nGalleryStdio[1] = 2;
    this.nGalleryStdio[2] = 5;
    this.nGalleryStdio[3] = 6;
    this.nGalleryStdio[4] = 7;
    this.nGalleryStdio[5] = 10;
    this.nGalleryStdio[6] = 9;
    this.effectBar = ((ProgressBar)findViewById(2131230862));
    this.effectGallery = ((GalleryText)findViewById(2131230858));
    effectType = 0;
    setGalleryImages(effectType);
    setGalleryImages(effectType, 0, true);
    set(0);
    this.effectGallery.setOnItemClickListener(this);//设置自条目点击事件监听对象
    this.effectGallery.setOnTouchListener(new OnTouchListenerGallery());
    paramBundle = (ImageButton)findViewById(2131230852);
    paramBundle.setOnClickListener(new myClickListenerDelete());
    paramBundle.setOnTouchListener(new onTouchListenerDelete());
    paramBundle = (ImageButton)findViewById(2131230853);
    paramBundle.setOnClickListener(new myClickListenerOk());
    paramBundle.setOnTouchListener(new onTouchListenerOk());
    this.fakeEffectView = ((ViewEditGalleryText)findViewById(2131230855));
    this.fakeEffectView.recycleBmpsrc();
    this.nextPicAnimation = AnimationUtils.loadAnimation(this, 2130968583);
    this.lastPicAnimation = AnimationUtils.loadAnimation(this, 2130968581);
    this.nextFakeAnimation = AnimationUtils.loadAnimation(this, 2130968585);
    this.lastFakeAnimation = AnimationUtils.loadAnimation(this, 2130968582);
    MTDebug.memeryUsed("StyleEffectActivity onCreate");
  }

    ...代码省略...

  public void onItemClick(AdapterView<?> paramAdapterView, View paramView, int paramInt, long paramLong)
  {
    if (this.isProcessing) {
      return;
    }
    set(paramInt);
  }

  ...代码省略...

  //底部横排的TextView被点击的时候调用，
  public void set(int paramInt)
  {
    for (;;)
    {
      try
      {
        System.gc();
        MTDebug.memeryUsed("StyleEffectActivity set arg=" + paramInt);
        if (effectType != 0) {
          break label238;
        }
        nCurGallerySelect = paramInt + 2099;
        MTDebug.Print("nSelectBmp =" + this.nSelectBmp + "arg" + paramInt);
        if ((this.nSelectBmp == paramInt) && (effectType == beforeType)) {
          break label225;
        }
        setGalleryImages(effectType, paramInt, true);
        if (paramInt == 0)
        {
          MTDebug.Print("set arg == 0");
          this.viewEffect.showProcess(nCurGallerySelect);
          this.viewEffect.processEffect(nCurGallerySelect);
          this.viewEffect.refresh();
          System.gc();
          return;
        }
        if (!this.viewEffect.isUsed(nCurGallerySelect))
        {
          setVisible();
          new Thread(new myThread()).start();
          this.viewEffect.showProcess(nCurGallerySelect);
          continue;
        }
        this.viewEffect.showProcess(nCurGallerySelect);
      }
      catch (Exception localException)
      {
        localException.printStackTrace();
        return;
      }
      this.viewEffect.processEffect(nCurGallerySelect);
      this.viewEffect.refresh();
      continue;
      label225:
      setGalleryImages(effectType, paramInt, true);
      continue;
      label238:
      if (effectType == 1)//这里我猜测是对应LOMO效果
      {
        MTDebug.Print("nSelectBmp =" + this.nSelectBmp + "arg" + paramInt);
        if ((this.nSelectBmp != paramInt) || (effectType != beforeType))
        {
          nCurGallerySelect = this.nGalleryLomo[paramInt] + 2099;
          if (!this.viewEffect.isUsed(nCurGallerySelect))
          {
            setVisible();
            new Thread(new myThread()).start();//开启一个线程,在这个线程中对图片进行美化处理，我们查看myThread做了什么
            this.viewEffect.showProcess(nCurGallerySelect);//显示一个还在进度条
          }
          for (;;)
          {
            setGalleryImages(effectType, paramInt, true);
            break;
            this.viewEffect.showProcess(nCurGallerySelect);
            this.viewEffect.processEffect(nCurGallerySelect);
            this.viewEffect.refresh();
          }
        }
        setGalleryImages(effectType, paramInt, true);
      }
      else if (effectType == 2)
      {
        MTDebug.Print("nSelectBmp =" + this.nSelectBmp + "arg" + paramInt);
        if ((this.nSelectBmp != paramInt) || (effectType != beforeType))
        {
          nCurGallerySelect = this.nGalleryStdio[paramInt] + 2099;
          if (!this.viewEffect.isUsed(nCurGallerySelect))
          {
            setVisible();
            new Thread(new myThread()).start();
            this.viewEffect.showProcess(nCurGallerySelect);
          }
          for (;;)
          {
            setGalleryImages(effectType, paramInt, true);
            break;
            this.viewEffect.showProcess(nCurGallerySelect);
            this.viewEffect.processEffect(nCurGallerySelect);
            this.viewEffect.refresh();
          }
        }
        setGalleryImages(effectType, paramInt, true);
      }
    }
  }

  public boolean setGalleryImages(int paramInt1, int paramInt2, boolean paramBoolean)
  {

     ...代码省略...
     
     this.effectGallery.setAdapter(new ImageApdater(this));//设置适配器
     
     ...代码省略...
  }

   ...代码省略...

  public class ImageApdater
    extends BaseAdapter
  {
    private Context myContext;
    
    public ImageApdater(Context paramContext)
    {
      this.myContext = paramContext;
    }
    
    public int getCount()
    {
      return StyleEffectActivity.nGalleryButtonNum;
    }
    
    public Object getItem(int paramInt)
    {
      return Integer.valueOf(paramInt);
    }
    
    public long getItemId(int paramInt)
    {
      return paramInt;
    }
    
    public View getView(int paramInt, View paramView, ViewGroup paramViewGroup)
    {
      localCanvas = null;
      for (;;)
      {
        try
        {
          MTDebug.Print("Get Viewposition~~~~~~" + paramInt);
          paramViewGroup = new ImageView(this.myContext);
          try
          {
            paramView = Bitmap.createBitmap((int)(66.0F * StyleEffectActivity.this.density), (int)(78.0F * StyleEffectActivity.this.density), Bitmap.Config.ARGB_8888);
            localCanvas = new Canvas(paramView);
            Object localObject = ImageProcess.FittingWindow888(BitmapFactory.decodeResource(StyleEffectActivity.this.getResources(), StyleEffectActivity.this.sListTest[paramInt]), (int)(54.0F * StyleEffectActivity.this.density), (int)(52.0F * StyleEffectActivity.this.density), true);
            localCanvas.drawBitmap((Bitmap)localObject, 5.0F * StyleEffectActivity.this.density, 0.0F, null);
            if ((localObject != null) && (!((Bitmap)localObject).isRecycled())) {
              ((Bitmap)localObject).recycle();
            }
            localObject = new Paint(1);
            ((Paint)localObject).setStyle(Paint.Style.FILL);
            ((Paint)localObject).setColor(-1);
            ((Paint)localObject).setTextSize(12.0F * StyleEffectActivity.this.density);
            str = StyleEffectActivity.this.getResources().getString(StyleEffectActivity.nGalleryButtonTextId[paramInt]);
            if (StyleEffectActivity.this.getCharsLength(str) == 3)
            {
              StyleEffectActivity.this.nTextLength = ((int)(20.0F * StyleEffectActivity.this.density));
              localCanvas.drawText(str, StyleEffectActivity.this.nTextLength, 70.0F * StyleEffectActivity.this.density, (Paint)localObject);
              paramViewGroup.setImageBitmap(paramView);
              paramViewGroup.setScaleType(ImageView.ScaleType.FIT_XY);
              return paramViewGroup;
            }
            if (StyleEffectActivity.this.getCharsLength(str) != 4) {
              continue;
            }
            StyleEffectActivity.this.nTextLength = ((int)(20.0F * StyleEffectActivity.this.density));
            continue;
            paramView.printStackTrace();
          }
          catch (Exception paramView) {}
        }
        catch (Exception paramView)
        {
          String str;
          paramViewGroup = localCanvas;
          continue;
        }
        return paramViewGroup;
        if (StyleEffectActivity.this.getCharsLength(str) == 6) {
          StyleEffectActivity.this.nTextLength = ((int)(15.0F * StyleEffectActivity.this.density));
        } else if (StyleEffectActivity.this.getCharsLength(str) == 7) {
          StyleEffectActivity.this.nTextLength = ((int)(7.0F * StyleEffectActivity.this.density));
        } else if (StyleEffectActivity.this.getCharsLength(str) == 8) {
          StyleEffectActivity.this.nTextLength = ((int)(5.0F * StyleEffectActivity.this.density));
        } else {
          StyleEffectActivity.this.nTextLength = 0;
        }
      }
    }
  }

  //所有效果按钮的点击事件监听对象
  class OnClassListenerAlleffectlable
    implements View.OnClickListener
  {

  }

    //LOMO效果按钮的点击事件监听对象
  class OnClassListenerLomoeffectlable
    implements View.OnClickListener
  {
    int nSetSelect;
    
    OnClassListenerLomoeffectlable() {}
    
    public void onClick(View paramView)
    {
   ...代码省略...
     }
  }

  //影楼效果按钮的点击事件监听对象
  class OnClassListenerPhotoeffectlable
    implements View.OnClickListener
  {
    int nSetSelect;
    
    OnClassListenerPhotoeffectlable() {}
    
    public void onClick(View paramView)
    {
     ...代码省略...
    }
  }
  
   ...代码省略...
  
  class myThread
    implements Runnable
  {
    myThread() {}
    
    public void run()
    {
      try
      {
        //这里调用了viewEffect对象的processEffect方法，在该方法内部进行图片美化处理，具体代码我们还是要进入ViewEditGalleryText对象内部查看
        StyleEffectActivity.this.isProcessing = true;
        StyleEffectActivity.this.viewEffect.processEffect(StyleEffectActivity.nCurGallerySelect);
        //然后这里开启了一个handler消息
        Message localMessage = new Message();
        localMessage.what = 257;
        StyleEffectActivity.this.myHandler.sendMessage(localMessage);
        StyleEffectActivity.this.isProcessing = false;
        return;
      }
      catch (Exception localException)
      {
        Thread.currentThread().interrupt();
      }
    }
  }
  
    ...代码省略...

}

```

代码中主要有两个控件ViewEditGalleryText和GalleryText，GalleryText控件主要实现了TextView横排显示的效果，在给这个控件设置自条目点击事件以及一些列其他操作之后，
最终如果我们点击LOMOB，LOMOC，OldPhoto等方法之后，会触发new myThread()).start()，开启一个线程,在这个线程中调用了ViewEditGalleryText对象的processEffect方法，对图片进行美化处理，
等待图片的美化功能完毕之后，会在handler中再次调用ViewEditGalleryText对象的updateShow()方法来进行图片刷新，把处理之后的二进制图片资源重新展示到控件上面。


6、ViewEditGalleryText的具体代码：

```java
public class ViewEditGalleryText
  extends View
{
  public int MIN = 0;
  public Bitmap bmpBack;
  public Bitmap bmpSrc;
  public float fScale = 1.0F;
  public float fSrcScale = 1.0F;
  public boolean isLoadOver = false;
  public boolean[] m_isEnable = new boolean[30];
  private int nCurUsedEffect = 0;
  public int nPicH = 0;
  public int nPicW = 0;
  public int nPicX = 0;
  public int nPicY = 0;
  private int nPosX = 0;
  private int nPosY = 0;
  public int nSrcPosX = 0;
  public int nSrcPosY = 0;
  public int nType;
  public int nViewHeight = 0;
  public int nViewWidth = 0;
  public Context pContext = null;

  public ViewEditGalleryText(Context paramContext, AttributeSet paramAttributeSet)
  {
    super(paramContext, paramAttributeSet);
    this.pContext = paramContext;
    if (!new File(MyData.strTempSDCardPath + "/style").mkdirs()) {
      MTDebug.Print("Error!create style folder failed!");
    }
    this.m_isEnable[0] = true;
  }

  public boolean Release()
  {
    try
    {
      if ((this.bmpBack != null) && (!this.bmpBack.isRecycled()))
      {
        this.bmpBack.recycle();
        this.bmpBack = null;
      }
      if ((this.bmpSrc != null) && (!this.bmpSrc.isRecycled()))
      {
        this.bmpSrc.recycle();
        this.bmpSrc = null;
      }
    }
    catch (Exception localException)
    {
      for (;;)
      {
        localException.printStackTrace();
      }
    }
    return true;
  }

  public Bitmap getAfterBitmap()
  {
    Object localObject = null;
    try
    {
      Bitmap localBitmap = this.bmpSrc;
      localObject = localBitmap;
      this.bmpSrc = null;
      return localBitmap;
    }
    catch (Exception localException)
    {
      localException.printStackTrace();
    }
    return localObject;
  }

  public boolean isAdjusted()
  {
    if (this.nCurUsedEffect <= 2099)
    {
      MTDebug.Print("viewEditGallery equal");
      return false;
    }
    return true;
  }

  public boolean isUsed(int paramInt)
  {
    paramInt -= 2099;
    if (paramInt >= 0) {
      try
      {
        int i = this.m_isEnable[paramInt];
        return i != 0;
      }
      catch (Exception localException)
      {
        localException.printStackTrace();
      }
    }
    return false;
  }

  protected void onDraw(Canvas paramCanvas)
  {
    super.onDraw(paramCanvas);
    if (this.nViewWidth == 0) {
      setPic();
    }
    if ((this.bmpBack != null) && (!this.bmpBack.isRecycled())) {
      paramCanvas.drawBitmap(this.bmpBack, this.nPosX + this.nSrcPosX, this.nPosY + this.nSrcPosY, null);
    }
  }

  //这里是在线程的内部，对图片进行处理
  public boolean processEffect(int paramInt)
  {
    for (;;)
    {
      try
      {
        this.nCurUsedEffect = paramInt;
        int i = paramInt - 2099;
        str = "";
        MTDebug.Print("nId=" + i);
        if (i >= 0)
        {
          str = MyData.strTempSDCardPath + "/style/" + i + ".jpg";
          if (i == 0)
          {
            if ((this.bmpSrc != null) && (!this.bmpSrc.isRecycled()))
            {
              this.bmpSrc.recycle();
              if ((this.bmpBack != null) && (!this.bmpBack.isRecycled()))
              {
                this.bmpBack.recycle();
                this.bmpBack = null;
              }
              MTDebug.Print("nId == 0");
              this.bmpSrc = MyData.bmpDst.copy(MyData.mConfig, true);
              //在这里调用了ImageProcess对象的FittingWindow方法
              this.bmpBack = ImageProcess.FittingWindow(this.bmpSrc, (int)(this.nViewWidth - MyData.nDensity * 20.0F), (int)(this.nViewHeight - MyData.nDensity * 20.0F), false);
              return true;
            }
            MTDebug.Print("GGG bmpSrc != null && !bmpSrc.isRecycled()");
          }
          if (this.m_isEnable[i] != 0)
          {
            if ((this.bmpSrc != null) && (!this.bmpSrc.isRecycled()))
            {
              this.bmpSrc.recycle();
              this.bmpSrc = null;
            }
            BitmapFactory.Options localOptions = new BitmapFactory.Options();
            localOptions.inDither = false;
            this.bmpSrc = BitmapFactory.decodeFile(str, localOptions);
            if ((this.bmpBack != null) && (!this.bmpBack.isRecycled()))
            {
              this.bmpBack.recycle();
              this.bmpBack = null;
            }
            this.bmpBack = ImageProcess.FittingWindow(this.bmpSrc, (int)(this.nViewWidth - MyData.nDensity * 20.0F), (int)(this.nViewHeight - MyData.nDensity * 20.0F), false);
            this.isLoadOver = true;
            invalidate();
            return true;
          }
          this.m_isEnable[i] = true;
        }
        if ((this.bmpSrc != null) && (!this.bmpSrc.isRecycled()))
        {
          this.bmpSrc.recycle();
          this.bmpSrc = null;
        }
        MTDebug.Print("viewEditGallery kind=" + paramInt);
        switch (paramInt)
        {
        }
      }
      catch (Exception localException)
      {
        String str;
        localException.printStackTrace();
        continue;
        this.bmpSrc = ImageProcess.StyleElegant(MyData.bmpDst, false);
        continue;
        this.bmpSrc = ImageProcess.StyleFilm(MyData.bmpDst, false);
        continue;
        this.bmpSrc = ImageProcess.StyleRetro(MyData.bmpDst, false);
        continue;
        this.bmpSrc = ImageProcess.StyleBrightRed(MyData.bmpDst, this.pContext, false);
        continue;
        this.bmpSrc = ImageProcess.StyleJapanese(MyData.bmpDst, false);
        continue;
        this.bmpSrc = ImageProcess.StyleBaoColor(MyData.bmpDst, this.pContext, false);
        continue;
        this.bmpSrc = ImageProcess.StyleImpression(MyData.bmpDst, this.pContext, false);
        continue;
        this.bmpSrc = ImageProcess.StyleG(MyData.bmpDst, this.pContext, false);
        continue;
        this.bmpSrc = ImageProcess.StyleLomoC(MyData.bmpDst, false);//我们来尝试这个
        continue;
        this.bmpSrc = ImageProcess.StyleLomoHDR(MyData.bmpDst, false);
        continue;
        this.bmpSrc = ImageProcess.StyleOldPhoto(MyData.bmpDst, this.pContext, false);//我们来尝试这个
        continue;
        this.bmpSrc = ImageProcess.StyleCinnamon(MyData.bmpDst, false);
        continue;
        this.bmpSrc = ImageProcess.StyleLomoB(MyData.bmpDst, false);//我们来尝试这个
        continue;
        this.bmpSrc = ImageProcess.StyleOldPhoto2(MyData.bmpDst, this.pContext, false);
        continue;
        this.bmpSrc = ImageProcess.StyleLomoA(MyData.bmpDst, this.pContext, false);
        continue;
        continue;
      }
      if (str != "") {
        ImageProcess.savePic(str, this.bmpSrc, 1);
      }
      this.isLoadOver = true;
      return true;
      this.bmpSrc = ImageProcess.StyleF(MyData.bmpDst, this.pContext, false);
    }
  }

    ...代码省略...

  //待图片资源被美化处理之后，调用这个方法刷新控件本身，把美化后的图片资源重新展示到原控件上面
  public void updateShow()
  {
    try
    {
      if (this.bmpSrc == null) {
        return;
      }
      if (this.bmpSrc.isRecycled()) {
        return;
      }
      if ((this.bmpBack != null) && (!this.bmpBack.isRecycled()))
      {
        this.bmpBack.recycle();
        this.bmpBack = null;
      }
      this.bmpBack = ImageProcess.FittingWindow(this.bmpSrc, (int)(this.nViewWidth - MyData.nDensity * 20.0F), (int)(this.nViewHeight - MyData.nDensity * 20.0F), false);
    }
    catch (Exception localException)
    {
      for (;;)
      {
        localException.printStackTrace();
      }
    }
    invalidate();
    return;
  }
}

```

比较重要的方法主要有两个processEffect()和updateShow()方法，在processEffect()方法中进一步调用ImageProcess的各类处理图片的方法来实现对图片的不同变化，最终调用updateShow()来展示鲜果。
